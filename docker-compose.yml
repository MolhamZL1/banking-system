services:
  db:
    image: postgres:16-alpine
    container_name: bank_db
    environment:
      POSTGRES_USER: appuser
      POSTGRES_PASSWORD: apppass
      POSTGRES_DB: appdb
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U appuser -d appdb"]
      interval: 5s
      timeout: 5s
      retries: 10

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bank_api

    env_file:
      - .env

    environment:
      NODE_ENV: development
      PORT: 3000

      # ✅ DATABASE_URL الصحيح داخل Docker
      DATABASE_URL: postgresql://appuser:apppass@db:5432/appdb?schema=public

      ADMIN_PASSWORD: "123456"

      JWT_SECRET: "ee537f503a31c9ab857d0ebbfb01514b8acbc55c9a624fe285f1ddc24c0ef80d"
      JWT_ACCESS_EXPIRES_IN: "15m"
      JWT_REFRESH_EXPIRES_IN: "30d"

      SMTP_HOST: "smtp.gmail.com"
      SMTP_PORT: "587"
      SMTP_USER: "molhamsa49@gmail.com"
      # SMTP_PASS رح يجي من .env.docker

    ports:
      - "3000:3000"

    depends_on:
      db:
        condition: service_healthy

    restart: on-failure

    # ✅ انتظر db يصير reachable + شغل migrate deploy من الـ local binary (بدون npx)
    command: >
      sh -c "
      node -e \"const net=require('net');
      const host='db', port=5432;
      const start=Date.now();
      (function retry(){
        const s=net.createConnection(port, host);
        s.on('connect',()=>{console.log('✅ DB is reachable'); s.end(); process.exit(0);});
        s.on('error',()=>{ if(Date.now()-start>60000){console.error('❌ DB not reachable'); process.exit(1);}
          setTimeout(retry,1000);});
      })();\"
      && ./node_modules/.bin/prisma migrate deploy
      && npm run start
      "

volumes:
  pgdata:
