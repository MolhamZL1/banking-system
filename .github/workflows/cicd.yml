name: Test & deploy to ghaymah

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push image
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/firstcicd:${{ github.sha }}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Install Ghaymah CLI
        run: |
          curl -sSl https://cli.ghaymah.systems/install.sh | bash
          test -x "$HOME/ghaymah/bin/gy"
          $HOME/ghaymah/bin/gy --version || true

      - name: Login to Ghaymah Cloud
        run: |
          $HOME/ghaymah/bin/gy auth login \
            --email "${{ secrets.GHAYMAH_EMAIL }}" \
            --password "${{ secrets.GHAYMAH_PW }}"

      - name: Deploy (update via JSON stdin)
        run: |
          echo "Deploying image: $IMAGE"

          cat <<JSON | $HOME/ghaymah/bin/gy resource app update 2066db54-89da-412c-b075-8aa94715ad19 --file -
          {
            "id": "2066db54-89da-412c-b075-8aa94715ad19",
            "values": {
              "name": "bank-app",
              "projectId": "7ba90855-ff3f-456b-b286-a90809aa0398",
              "container": {
                "image": "$IMAGE"
              },
              "ports": [
                { "expose": true, "number": 3000 }
              ],
              "publicAccess": {
                "enabled": true,
                "domain": "auto",
                "baseDomain": "hosted.ghaymah.systems"
              },
              "resourceTier": "t1"
            }
          }
          JSON
