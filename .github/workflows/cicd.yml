name: Test & deploy to ghaymah

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: npm ci

      - name: Run tests
        run: npm test

  deploy:
    needs: build_and_push_image
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v5.0.0

      - name: ğŸŒ©ï¸ Install Ghaymah CLI
        run: curl -sSl https://cli.ghaymah.systems/install.sh | bash

      - name: ğŸ” Login to Ghaymah Cloud
        run: $HOME/ghaymah/bin/gy auth login --email "${{ secrets.GHAYMAH_EMAIL }}" --password "${{ secrets.GHAYMAH_PW }}"

      - name: ğŸš€ Deploy Application
        run: $HOME/ghaymah/bin/gy resource app launch
